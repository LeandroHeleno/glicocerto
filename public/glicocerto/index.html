<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>GlicoCerto</title>
  <link rel="manifest" href="/glicocerto/manifest.webmanifest">
  <meta name="theme-color" content="#2aa775">
  <link rel="icon" href="/glicocerto/icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/glicocerto/icons/icon-192.png">

  <style>
    :root { --brand:#2aa775; --brand-700:#248c62; --bg:#f6f6f6; --text:#1f2937; --muted:#6b7280; --card:#ffffff; --border:#e7e7e7; --thead:#f5f5f5; }
    :root[data-theme="dark"]{ --bg:#0b0b0c; --card:#111114; --text:#e5e7eb; --border:#25262b; --muted:#9ca3af; --thead:#141519; }
    :root{ --input-bg:#ffffff; --input-text:#111; --input-border:#dddddd; }
    :root[data-theme="dark"]{ --input-bg:#16171b; --input-text:#e5e7eb; --input-border:#2a2b31; }
    *{box-sizing:border-box}
    html, body { height:100%; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background: var(--bg); color: var(--text); margin:0; line-height:1.45; }

    header { position: sticky; top: 0; z-index: 100; background: var(--brand); color:#fff; padding:10px 12px; font-size:18px; font-weight:700; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .left-brand{ display:flex; align-items:center; gap:8px; }
    .auth-box{ display:flex; align-items:center; gap:8px; flex-wrap:nowrap; }
    .brand-logo {
      width: 28px;      /* tamanho base em telas pequenas */
      height: 28px;
      object-fit: contain;
    }

    @media (min-width: 720px) {
      .brand-logo {
        width: 32px;
        height: 32px;
      }
    }

    @media (min-width: 1120px) {
      .brand-logo {
        width: 36px;
        height: 36px;
      }
    }

    .theme-icon-btn{
      background:rgba(255,255,255,.18); color:#fff; border:1px solid rgba(255,255,255,.25);
      width:36px; height:36px; border-radius:999px; font-size:16px; cursor:pointer;
      display:grid; place-items:center; line-height:1;
    }

    .ns-badge{
      background:#ffffff; color:#111827; border-radius:999px;
      padding:4px 8px; min-height:28px; display:none; align-items:center; justify-content:center; gap:6px; white-space:nowrap;
      border:1px solid rgba(0,0,0,.06); font-weight:700; font-size:12px;
      max-width: 38vw; overflow:hidden; text-overflow:ellipsis;
    }
    .ns-badge .dot{width:8px; height:8px; border-radius:50%; background:#10b981; display:inline-block}

    .user-chip{ display:flex; align-items:center; gap:6px; position:relative; }
    .avatar,.initials{ width:28px; height:28px; border-radius:50%; }
    .avatar{ object-fit:cover; background:#eee; border:1px solid rgba(0,0,0,.05); }
    .initials{ display:grid; place-items:center; background:#0ea5e9; color:#fff; font-weight:700; font-size:12px; border:1px solid rgba(0,0,0,.05); }
    .menu-btn{ background:#fff; color:#111827; border:none; border-radius:10px; min-height:32px; padding:6px 10px; cursor:pointer; font-weight:600; }

    .dropdown{
      position:absolute; right:0; top:42px; background:var(--card); color:var(--text);
      border:1px solid var(--border); border-radius:12px; min-width:200px;
      box-shadow:0 12px 28px rgba(0,0,0,.18); display:none; overflow:hidden;
    }
    .dropdown.open{ display:block; }
    .dropdown .hd{ padding:10px 12px; font-size:12px; color:var(--muted); border-bottom:1px solid var(--border); }
    .dropdown button{
      width:100%; text-align:left; padding:10px 12px; background:none; border:none; cursor:pointer; font:inherit; color:var(--text);
      display:flex; align-items:center; gap:8px;
    }
    .dropdown button:hover{ background:var(--thead); }

    main { width:100%; margin:0 auto; padding:16px; padding-bottom: 90px; }
    .tabs { display:flex; gap:8px; margin:0 0 12px; padding:0 2px 4px; flex-wrap:wrap; }
    .tab-btn { border:1px solid var(--border); background:#fff; padding:10px 14px; cursor:pointer; border-radius:999px; min-height:40px; }
    .tab-btn.active { background: var(--brand); color:#fff; border-color: var(--brand); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow: 0 1px 2px rgba(0,0,0,.03); margin-bottom:12px; }

    .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    .grid-3 { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 720px){
      main { max-width: 900px; }
      .grid { grid-template-columns: repeat(2, minmax(180px,1fr)); }
      .grid-3 { grid-template-columns: repeat(3, minmax(160px,1fr)); }
    }
    @media (min-width: 1120px){ main { max-width: 1100px; } }

    label { font-size:13px; color:#374151; display:block; margin-bottom:4px; }
    input, select, textarea {
      width:100%; padding:12px; border:1px solid var(--input-border)!important; border-radius:10px; background:var(--input-bg)!important; color:var(--input-text)!important; font:inherit;
    }
    input:focus, select:focus, textarea:focus { outline: 2px solid #cff5e4; border-color: var(--brand)!important; box-shadow:0 0 0 2px rgba(42,167,117,.15); }
    textarea { min-height:110px; resize:vertical; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btn { background: var(--brand); border:none; color:#fff; padding:12px 16px; border-radius:12px; cursor:pointer; min-height:44px; font-weight:600; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn:hover{ background: var(--brand-700); }
    .btn-del { background:#e11d48; color:#fff; border:none; padding:8px 10px; border-radius:10px; cursor:pointer; min-height:40px; }

    .muted { color:var(--muted); font-size:12px; }
    .note{background:#fff3cd;border:1px solid #ffeeba;color:#856404;padding:10px;border-radius:10px;margin-top:10px;}
    .resumo { white-space:pre-wrap; background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:12px; margin-top:12px; }
    .resumo strong{ font-weight:800 }
    .disclaimer { margin-top:10px; font-size:12px; color:#666; }
    details summary { cursor:pointer; user-select:none; }
    .ok{color:#1e7e34} .err{color:#b91c1c}

    .table-wrap { overflow:auto; -webkit-overflow-scrolling:touch; border:1px solid var(--border); border-radius:12px; }
    table { width:100%; border-collapse: collapse; min-width: 900px; background: var(--card); color: var(--text); }
    th, td { border-bottom:1px solid var(--border); padding:10px 8px; text-align:left; font-size:14px; vertical-align:top; }
    th { background: var(--thead); position: sticky; top:0; z-index:1; }

    .details-clean { border:1px solid var(--border); border-radius:10px; padding:10px; background:var(--card); }
    .details-clean .gc-table{ width:100%; border-collapse:collapse; font-size:14px; }
    .details-clean .gc-table th, .details-clean .gc-table td{ border:1px solid var(--border); padding:6px 8px; text-align:left; }
    .details-clean .gc-table th{ background:var(--thead); }

    .bottom-nav{ position:fixed; left:0; right:0; bottom:0; height:64px; background:var(--card); border-top:1px solid var(--border); display:none; align-items:center; justify-content:space-around; z-index:200; }
    .bottom-nav button{ background:none; border:none; font:inherit; color:var(--text); display:flex; flex-direction:column; align-items:center; gap:4px; padding:8px 12px; border-radius:12px; }
    .bottom-nav button.active{ color:#fff; background:var(--brand); }
    .bottom-nav .icon{ font-size:18px; line-height:1; }

    @media (max-width: 720px){
      .tabs{ display:none; }
      body{ padding-bottom:72px; }
      .bottom-nav{ display:flex; }
    }

    html:not([data-theme="dark"]) input, html:not([data-theme="dark"]) select, html:not([data-theme="dark"]) textarea{ color-scheme: light; }
    html[data-theme="dark"] input, html[data-theme="dark"] select, html[data-theme="dark"] textarea{ color-scheme: dark; }
  </style>
</head>
<body>

<header>
  <div class="left-brand">
    <img src="/glicocerto/icons/icon-192.png" alt="Logo GlicoCerto" class="brand-logo">
    <span>GlicoCerto</span>
    <span id="nsBadge" class="ns-badge">
      <span class="dot"></span>
      <span id="nsBadgeVal">--</span>
    </span>
  </div>
  <div class="auth-box">
    <button id="btnNovo" class="menu-btn">Novo</button>
    <button id="btnLogout" class="menu-btn">Sair</button>
  </div>
</header>

<main>
  <div class="tabs">
    <button class="tab-btn active" data-tab="chat">Calcular</button>
    <button class="tab-btn" data-tab="historico">Histórico</button>
    <button class="tab-btn" data-tab="paciente">Paciente</button>
  </div>

  <!-- CHAT -->
  <section id="chat" class="card">
    <div class="grid">
      <div>
        <label>Descrição / Itens</label>
        <textarea id="mensagem" placeholder="Ex.: 80g arroz, 50g feijão..."></textarea>
      </div>
      <div>
        <label>Glicemia (mg/dL) <span id="glicemiaSource" class="muted">(digite manualmente)</span></label>
        <input id="glicemia" type="number" inputmode="numeric" placeholder="Ex.: 110" />
      </div>
      <div>
        <label>Tipo de refeição</label>
        <select id="tipo_refeicao">
          <option value="cafe">Café</option>
          <option value="almoco">Almoço</option>
          <option value="jantar">Jantar</option>
          <option value="lanche">Lanche</option>
          <option value="outro" selected>Outro</option>
        </select>
      </div>
      <div>
        <label>Estratégia proteína+gordura</label>
        <select id="pg_strategy">
          <option value="regular_now" selected>Regular agora</option>
          <option value="rapid_later">Rápida mais tarde</option>
        </select>
      </div>

      <div>
        <label>Foto (opcional)</label>
        <!-- sem capture p/ abrir galeria tbm; múltiplos navegadores -->
        <input id="foto" type="file" accept="image/*" />
        <img id="previewFoto" alt="preview" style="display:none; width:120px; height:120px; object-fit:cover; margin-top:8px; border:1px solid var(--border); border-radius:10px;">
        <button id="btnLimparFoto" class="menu-btn" style="display:none; margin-top:6px;">Remover foto</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btn" id="btnEnviar">Enviar</button>
    </div>

    <div id="resumo" class="resumo" style="margin-top:10px;">Aguardando…</div>

    <details id="detalhesBox" class="details-clean" style="display:none; margin-top:12px;">
      <summary>ver detalhes técnicos</summary>
      <div id="detalhesHTML" style="margin-top:8px;"></div>
    </details>

    <div class="disclaimer">⚠️ Este app não substitui orientação médica.</div>
  </section>

  <!-- HISTÓRICO -->
  <section id="historico" class="card" style="display:none;">
    <div class="row">
      <div><label>Início</label><input type="date" id="f_inicio"></div>
      <div><label>Fim</label><input type="date" id="f_fim"></div>
      <div>
        <label>Tipo</label>
        <select id="f_tipo">
          <option value="todos">Todos</option>
          <option value="cafe">Café</option>
          <option value="almoco">Almoço</option>
          <option value="jantar">Jantar</option>
          <option value="lanche">Lanche</option>
          <option value="outro">Outro</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:8px; gap:6px;">
      <button id="btnFiltrar" class="menu-btn">Filtrar</button>
      <button id="btnHoje" class="menu-btn">Hoje</button>
      <button id="btnSemana" class="menu-btn">Semana</button>
      <button id="btnMes" class="menu-btn">Mês</button>
      <button id="btnBaixar" class="menu-btn">Baixar XLSX (filtro)</button>
    </div>

    <div class="table-wrap" style="margin-top:12px;">
      <table id="tHistorico">
        <thead>
          <tr>
            <th>Data</th><th>Tipo</th><th>Glicemia</th><th>Descrição</th>
            <th>CHO (g)</th><th>PG eq (g)</th><th>Rápida (U)</th><th>Regular (U)</th><th>Foto</th><th>Ações</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="10">Faça login…</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- PACIENTE -->
  <section id="paciente" class="card" style="display:none;">
    <p>Configurações do paciente (ICR, ISF, alvo, etc.).</p>
  </section>
</main>

<nav id="bottomNav" class="bottom-nav">
  <button data-tab="chat"><span class="icon">💉</span><span>Calcular</span></button>
  <button data-tab="historico"><span class="icon">📜</span><span>Histórico</span></button>
  <button data-tab="paciente"><span class="icon">👤</span><span>Paciente</span></button>
</nav>

<!-- libs p/ XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

<script type="module">
  // ===== Supabase (mínimo) =====
  const SUPABASE_URL = window.SUPABASE_URL || '';
  const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '';
  const { createClient } = window.supabase || {};
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

<script>
  const SUPABASE = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  let USER_ID = null;

  // ---------- Helpers ----------
  function sanitizeModelHtml(raw){
    return String(raw||'')
      .replace(/```html|```/g,'')
      .replace(/<pre[\s\S]*?<\/pre>/gi,'')
      .trim();
  }

  // Reduz e converte arquivo de imagem para dataURL (para celular não travar)
  function downscaleToDataURL(file, max=300, quality=0.85){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      const fr = new FileReader();
      fr.onload = () => { img.src = fr.result; };
      fr.onerror = reject;
      img.onload = () => {
        const { width:w, height:h } = img;
        const scale = Math.min(1, max/Math.max(w,h));
        const cw = Math.max(1, Math.round(w*scale));
        const ch = Math.max(1, Math.round(h*scale));
        const canvas = document.createElement('canvas');
        canvas.width=cw; canvas.height=ch;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0,cw,ch);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.onerror = reject;
      fr.readAsDataURL(file);
    });
  }

  function rint(n){ return Math.round(Number(n||0)); }

  async function initSupabase(){
    const { data:{ user } } = await SUPABASE.auth.getUser();
    USER_ID = user?.id || null;
    document.getElementById('btnLogout').onclick = async () => {
      await SUPABASE.auth.signOut();
      stopNsHeaderTimer(); hideNsBadge();
      document.getElementById('mensagem').value='';
      document.getElementById('glicemia').value='';
      document.querySelector('#tHistorico tbody')?.replaceChildren();
      const f=document.getElementById('foto'); if(f) f.value='';
      const p=document.getElementById('previewFoto'); if(p){ p.src=''; p.style.display='none'; }
      document.getElementById('glicemia').readOnly=false; document.getElementById('glicemiaSource').textContent='';
    };
    if (USER_ID) startNsHeaderTimer();
  }

  async function getAuthHeaders(){
    const {data:{session}}=await SUPABASE.auth.getSession();
    const t=session?.access_token;
    return t?{Authorization:`Bearer ${t}`}:{};
  }

  // ===== Tabs =====
  function showTab(target){
    const sections={
      paciente:document.getElementById('paciente'),
      chat:document.getElementById('chat'),
      historico:document.getElementById('historico')
    };
    Object.values(sections).forEach(el=>el && (el.style.display='none'));
    document.querySelectorAll('.tab-btn').forEach(t=>t.classList.remove('active'));
    ['bnPaciente','bnChat','bnHistorico'].forEach(id=>document.getElementById(id)?.classList.remove('active'));
    const t=target||'chat';
    if(sections[t]) sections[t].style.display='block';
    const btn=[...document.querySelectorAll('.tab-btn')].find(b=>b.dataset.tab===t);
    if(btn) btn.classList.add('active');
    const bn=document.getElementById('bottomNav');
    bn?.querySelectorAll('button').forEach(b=>{ if(b.dataset.tab===t) b.classList.add('active'); });
    if(t==='historico') carregarHistorico();
    window.scrollTo({top:0, behavior:'smooth'});
  }
  document.querySelectorAll('.tab-btn').forEach(b=>b.onclick=()=>showTab(b.dataset.tab));
  document.getElementById('bottomNav')?.addEventListener('click',(ev)=>{
    const btn=ev.target.closest('button[data-tab]'); if(!btn) return; showTab(btn.dataset.tab);
  });

  // ===== Foto =====
  function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
  const inpFoto=document.getElementById('foto');
  const prev=document.getElementById('previewFoto');
  const btnLimparFoto=document.getElementById('btnLimparFoto');

  inpFoto?.addEventListener('change', ()=>{
    const f=inpFoto.files?.[0];
    if(!f){ prev.style.display='none'; btnLimparFoto.style.display='none'; return; }
    fileToDataURL(f).then(d=>{
      prev.src=d; prev.style.display='block'; btnLimparFoto.style.display='inline-block';
    });
  });
  btnLimparFoto?.addEventListener('click', ()=>{
    inpFoto.value=''; prev.src=''; prev.style.display='none'; btnLimparFoto.style.display='none';
  });

  // ===== Nightscout badge + auto-preencher glicemia =====
  const nsBadge=document.getElementById('nsBadge');
  const nsBadgeVal=document.getElementById('nsBadgeVal');
  const NS_REFRESH_MS=240000; let nsHeaderTimer=null;

  function hideNsBadge(){
    nsBadge.style.display='none'; nsBadgeVal.textContent='--';
    document.getElementById('glicemiaSource').textContent='(digite manualmente)';
    const gi=document.getElementById('glicemia'); gi.readOnly=false;
  }
  async function refreshNSBadge(){
    if(!USER_ID) return hideNsBadge();
    try{
      const h=await getAuthHeaders();
      const rCfg=await fetch(`/api/paciente/${encodeURIComponent(USER_ID)}`,{headers:{...h}});
      const jCfg=await rCfg.json();
      const urlNS=jCfg?.data?.nightscout_url?.trim();
      if(!urlNS){ hideNsBadge(); return; }
      const r=await fetch(`/api/ns/latest/${encodeURIComponent(USER_ID)}`,{headers:{...h}});
      const j=await r.json();
      if(!j.ok||!j.data){ hideNsBadge(); return; }
      const mgdl=Number(j.data.mgdl);
      nsBadgeVal.textContent = `${mgdl} mg/dL`;
      nsBadge.style.display='inline-flex';
      const chatVisivel=document.getElementById('chat')?.style.display!=='none';
      const glicInp=document.getElementById("glicemia");
      const src=document.getElementById("glicemiaSource");
      if(glicInp){ glicInp.value=String(mgdl); glicInp.readOnly=true; if(src) src.textContent='(Nightscout)'; if(chatVisivel) validarCampos?.(); }
    }catch(e){ console.warn('NS badge:',e); hideNsBadge(); }
  }
  function startNsHeaderTimer(){ stopNsHeaderTimer(); refreshNSBadge(); nsHeaderTimer=setInterval(refreshNSBadge, NS_REFRESH_MS); }
  function stopNsHeaderTimer(){ if(nsHeaderTimer){ clearInterval(nsHeaderTimer); nsHeaderTimer=null; } }
  document.addEventListener('visibilitychange',()=>{ if(document.hidden) stopNsHeaderTimer(); else if(USER_ID) startNsHeaderTimer(); });

  // Botão “Novo”
  document.getElementById('btnNovo')?.addEventListener('click', () => {
    const msg=document.getElementById('mensagem'); if(msg) msg.value='';
    const f=document.getElementById('foto'); const p=document.getElementById('previewFoto'); const rm=document.getElementById('btnLimparFoto');
    if(f) f.value=''; if(p){ p.src=''; p.style.display='none'; } if(rm) rm.style.display='none';
    document.getElementById('tipo_refeicao').value='outro';
    const resumo=document.getElementById('resumo'); const detalhesBox=document.getElementById('detalhesBox'); const detalhesHTML=document.getElementById('detalhesHTML');
    if(resumo) resumo.textContent='Aguardando…'; if(detalhesHTML) detalhesHTML.innerHTML=''; if(detalhesBox){ detalhesBox.style.display='none'; detalhesBox.open=false; }
    refreshNSBadge();
  });

  // ===== Histórico =====
  let HIST_CACHE=[];
  function fmtData(iso){ try{ const dt=new Date(iso); return dt.toLocaleString(); }catch{ return iso; } }

  async function carregarHistorico(){
    if(!USER_ID) return;
    const tbody=document.querySelector('#tHistorico tbody'); tbody.innerHTML='<tr><td colspan="10">Carregando…</td></tr>';
    try{
      const h=await getAuthHeaders();
      const params=new URLSearchParams({ userId:USER_ID });
      const ini=document.getElementById('f_inicio').value;
      const fim=document.getElementById('f_fim').value;
      const tipo=document.getElementById('f_tipo').value;
      if(ini) params.set('start', new Date(ini+'T00:00:00').toISOString());
      if(fim) params.set('end', new Date(fim+'T23:59:59.999').toISOString());
      if(tipo && tipo!=='todos') params.set('tipo', tipo);

      const r=await fetch('/api/refeicoes?'+params.toString(),{headers:{...h}});
      const j=await r.json();
      if(!j.ok){ tbody.innerHTML=`<tr><td colspan="10">${j.error||'Falha ao carregar.'}</td></tr>`; return; }

      HIST_CACHE = Array.isArray(j.data) ? j.data : [];
      if(HIST_CACHE.length===0){ tbody.innerHTML=`<tr><td colspan="10">Sem registros.</td></tr>`; return; }
      tbody.innerHTML='';
      HIST_CACHE.forEach(row=>{
        const desc=((row.descricao||'').replace(/^\[foto\]\s*/i,'').replace(/\s+/g,' ').slice(0,180));
        const fotoCell=row.foto_url ? `<a href="${row.foto_url}" target="_blank" rel="noopener"><img src="${row.foto_url}" style="width:48px;height:48px;object-fit:cover;border-radius:6px;border:1px solid #eee" /></a>` : '-';
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${fmtData(row.data_hora)}</td>
          <td>${(row.tipo||'').toUpperCase()}</td>
          <td>${row.glicemia ?? '-'}</td>
          <td>${desc}</td>
          <td>${Number(row.cho_total_g||0).toFixed(1)}</td>
          <td>${Number(row.pg_cho_equiv_g||0).toFixed(1)}</td>
          <td>${Number(row.dose_rapida_total||0).toFixed(1)}</td>
          <td>${Number(row.dose_regular_pg||0).toFixed(1)}</td>
          <td>${fotoCell}</td>
          <td><button class="btn-del" title="Excluir" data-id="${row.id}">🗑️</button></td>`;
        tbody.appendChild(tr);
      });
    }catch(e){ console.error(e); tbody.innerHTML=`<tr><td colspan="10">Erro ao carregar.</td></tr>`; }
  }

  function exportHistoricoXLSX(){
    if(!Array.isArray(HIST_CACHE) || HIST_CACHE.length===0){
      alert('Nada para exportar: aplique um filtro que retorne dados.');
      return;
    }
    const rows = HIST_CACHE.map(r => ({
      Data: new Date(r.data_hora).toLocaleString(),
      Tipo: (r.tipo || '').toUpperCase(),
      Glicemia_mg_dL: r.glicemia ?? '',
      Descricao: (r.descricao || '').replace(/^\[foto\]\s*/i,''),
      CHO_g: Number(r.cho_total_g || 0),
      'Prot+Gord (CHO eq g)': Number(r.pg_cho_equiv_g || 0),
      'Insulina A (rápida)': Number(r.dose_rapida_total || 0),
      'Insulina B (Regular)': Number(r.dose_regular_pg || 0),
      FotoURL: r.foto_url || ''
    }));
    const ws = XLSX.utils.json_to_sheet(rows);
    ws['!cols'] = [{wch:19},{wch:8},{wch:12},{wch:50},{wch:8},{wch:16},{wch:16},{wch:18},{wch:28}];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Historico');
    const ini = document.getElementById('f_inicio').value || '';
    const fim = document.getElementById('f_fim').value || '';
    const tipo = document.getElementById('f_tipo').value || 'todos';
    const stamp = new Date().toISOString().slice(0,10);
    const fname = `glicocerto_historico_${tipo}_${ini||'inicio'}_${fim||'fim'}_${stamp}.xlsx`;
    XLSX.writeFile(wb, fname);
  }

  document.getElementById('btnFiltrar')?.addEventListener('click', carregarHistorico);
  document.getElementById('btnHoje')?.addEventListener('click', ()=>{
    const d=new Date(); const iso=d.toISOString().slice(0,10);
    document.getElementById('f_inicio').value=iso;
    document.getElementById('f_fim').value=iso;
    carregarHistorico();
  });
  document.getElementById('btnSemana')?.addEventListener('click', ()=>{
    const fim=new Date(); const ini=new Date(Date.now()-6*86400000);
    document.getElementById('f_inicio').value=ini.toISOString().slice(0,10);
    document.getElementById('f_fim').value=fim.toISOString().slice(0,10);
    carregarHistorico();
  });
  document.getElementById('btnMes')?.addEventListener('click', ()=>{
    const fim=new Date(); const ini=new Date(Date.now()-29*86400000);
    document.getElementById('f_inicio').value=ini.toISOString().slice(0,10);
    document.getElementById('f_fim').value=fim.toISOString().slice(0,10);
    carregarHistorico();
  });
  document.getElementById('btnBaixar')?.addEventListener('click', exportHistoricoXLSX);

  // Exclusão no histórico
  document.addEventListener('click', async (ev) => {
    const t=ev.target;
    if(t?.classList?.contains('btn-del')){
      const id=t.getAttribute('data-id'); if(!id||!confirm('Excluir este registro?')) return;
      try{
        const h=await getAuthHeaders();
        const url=`/api/refeicoes/${encodeURIComponent(id)}?userId=${encodeURIComponent(USER_ID)}`;
        const r=await fetch(url,{ method:'DELETE', headers:{...h} });
        const j=await r.json();
        if(!j.ok){ alert('Falha ao excluir: '+(j.error||'')); return; }
        carregarHistorico();
      }catch(e){ alert('Erro de rede ao excluir.'); }
    }
  });

  // ===== Enviar =====
  document.getElementById('btnEnviar').onclick = async () => {
    if(!USER_ID){ alert('Faça login para enviar.'); return; }
    const resumo=document.getElementById('resumo');
    const detalhesBox=document.getElementById('detalhesBox');
    const detalhesHTML=document.getElementById('detalhesHTML');

    const mensagem=document.getElementById('mensagem').value.trim();
    const glicemia=Number(document.getElementById('glicemia').value);
    const tipo=document.getElementById('tipo_refeicao').value||'outro';
    const strat=document.getElementById('pg_strategy').value;

    resumo.textContent='Calculando...';
    detalhesBox.style.display='none'; detalhesHTML.innerHTML='';

    try{
      const h=await getAuthHeaders();
      const hasPhoto = !!(document.getElementById('foto')?.files?.length);
      let payload = { userId:USER_ID, glicemia, pg_strategy:strat, tipo };
      let url = '/api/chat';

      if(hasPhoto){
        const f=document.getElementById('foto').files[0];
        // Compacta p/ celular não travar
        const dataUrl = await downscaleToDataURL(f, 300, 0.85);
        url='/api/chat-image';
        payload.image_data_url=dataUrl;
        if(mensagem) payload.message=mensagem;
      }else{
        payload.message=mensagem;
      }

      const r=await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json', ...h}, body:JSON.stringify(payload) });
      const d=await r.json();
      if(!d.ok){ resumo.textContent='Erro: '+(d.error||'Falha no cálculo.'); return; }

      // Resumo humanizado (igual ao seu fluxo atual)
      const t=d.totais||{};
      const cho_total = Number(t.carbo_g||0);
      const pg_cho_eq = Number(t.pg_cho_equiv_g||0);
      const icr = Number(d.config?.insulina_cho||10);
      const isf = Number(d.config?.glicose_insulina||50);
      const alvo = Number(d.config?.target||100);
      const glicVal = Number(d.input?.glicemia ?? glicemia);
      const stratUsed = (d.config?.pg_strategy||'regular_now');

      const doseCho = cho_total/icr;
      const doseCor = Math.max(0,(glicVal-alvo)/isf);
      const dosePg  = (stratUsed==='regular_now') ? (pg_cho_eq/icr) : 0;

      const choU_i = rint(doseCho);
      const corU_i = rint(doseCor);
      const pgU_i  = rint(dosePg);
      const totalFiasp_i = rint(doseCho+doseCor);

      const insRapida=(d.config?.insulina_rapida||'Fiasp').trim();
      const refeicaoTxt=(d.input?.descricao||mensagem||'[foto]').replace(/\s+/g,' ').trim();

      const linhas=[
        `Para a refeição “${refeicaoTxt}” (glicemia: ${glicVal} mg/dL):`,
        `• ${choU_i}U + ${corU_i}U de ${insRapida.toUpperCase()} para carboidratos e correção`
      ];
      if(stratUsed==='regular_now'){
        linhas.push(`• ${pgU_i}U de Insulina Regular (R) para proteína e gordura.`);
        linhas.push(`• Total: ${totalFiasp_i}U ${insRapida.toUpperCase()} ; ${pgU_i}U Regular`);
      }else{
        linhas.push(`• Proteína/gordura: não aplicar agora; ver detalhes.`);
        linhas.push(`• Total imediato: ${totalFiasp_i}U ${insRapida.toUpperCase()}`);
      }
      resumo.textContent = linhas.join('\n');

      // Detalhes técnicos
      const raw = d.detalhes_html || '';
      const clean = sanitizeModelHtml(raw);
      detalhesHTML.innerHTML = clean || '<em>Sem detalhes técnicos disponíveis.</em>';
      detalhesBox.style.display='block'; detalhesBox.open=false;

    }catch(e){
      console.error(e);
      resumo.textContent='Erro ao conectar com o servidor.';
    }
  };

  // ===== Inicialização =====
  initSupabase();
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/glicocerto/sw.js', { scope: '/glicocerto/' });
    });
  }
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // Se quiser exibir um botão "Instalar", chame deferredPrompt.prompt() ao clicar
  });
</script>

</body>
</html>
